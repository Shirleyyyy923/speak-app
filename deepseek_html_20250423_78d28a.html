<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦éœ¸æ•™è‚²è¡¥ä¹ ä¸­å¿ƒ - è‹±æ–‡ä¼šè¯ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            -webkit-text-size-adjust: 100%;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }
        h3 {
            color: #3498db;
            margin-top: 20px;
            font-size: 1.1rem;
        }
        select, button {
            padding: 14px 20px;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            width: 100%;
            box-sizing: border-box;
            -webkit-appearance: none;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            min-height: 54px;
            font-size: 17px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        #output, #topic, #score, #feedback {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            min-height: 20px;
            text-align: left;
            word-break: break-word;
            font-size: 16px;
        }
        #topic {
            font-weight: bold;
            color: #e74c3c;
        }
        #score {
            font-weight: bold;
            color: #27ae60;
        }
        .recording {
            background-color: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        #error {
            color: #e74c3c;
            margin: 10px 0;
            min-height: 20px;
            font-size: 15px;
        }
        #tips {
            margin-top: 25px;
            padding: 15px;
            background-color: #e8f4fc;
            border-left: 4px solid #3498db;
            border-radius: 0 8px 8px 0;
            font-size: 15px;
        }
        #tips h3 {
            color: #2c3e50;
            margin-top: 0;
            font-size: 1.1rem;
        }
        #tips ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        #tips li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .ios-hint {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
        }
        .ios-tips {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
        }
        .ios-tips h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .ios-tips ol {
            padding-left: 20px;
        }
        .ios-tips li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>å­¦éœ¸æ•™è‚²è¡¥ä¹ ä¸­å¿ƒ - è‹±æ–‡ä¼šè¯ç³»ç»Ÿ</h2>
        
        <label for="difficulty">é€‰æ‹©éš¾åº¦ï¼š</label>
        <select id="difficulty">
            <option value="easy">åˆçº§ (A1-A2)</option>
            <option value="medium">ä¸­çº§ (B1-B2)</option>
            <option value="hard">é«˜çº§ (C1-C2)</option>
        </select>
        <button id="generateBtn">ç”Ÿæˆä¸»é¢˜</button>

        <h3>ä¼šè¯ä¸»é¢˜ï¼š</h3>
        <div id="topic">ï¼ˆè¯·ç‚¹å‡»æŒ‰é’®ç”Ÿæˆä¸»é¢˜ï¼‰</div>

        <button id="recordBtn" disabled>ğŸ¤ å¼€å§‹å½•éŸ³</button>
        <p class="ios-hint">iPhoneç”¨æˆ·è¯·ç¡®ä¿å·²å…è®¸éº¦å…‹é£æƒé™</p>
        <button id="stopBtn" disabled>â¹ åœæ­¢å½•éŸ³</button>

        <h3>æ‚¨çš„å›ç­”ï¼š</h3>
        <div id="output">ï¼ˆå½•éŸ³åä¼šæ˜¾ç¤ºæ‚¨çš„å›ç­”ï¼‰</div>
        
        <div id="error"></div>

        <button id="evaluateBtn" disabled>è¯„ä¼°å›ç­”</button>
        <h3>è¯„ä¼°ç»“æœï¼š</h3>
        <div id="score">ï¼ˆç‚¹å‡»è¯„ä¼°åæŸ¥çœ‹åˆ†æ•°ï¼‰</div>
        <div id="feedback"></div>

        <div class="ios-tips">
            <h3>iPhoneä½¿ç”¨æç¤ºï¼š</h3>
            <ol>
                <li>é¦–æ¬¡ä½¿ç”¨éœ€<strong>å…è®¸éº¦å…‹é£æƒé™</strong></li>
                <li>è¯´è¯æ—¶é è¿‘æ‰‹æœºåº•éƒ¨éº¦å…‹é£</li>
                <li>ä¿æŒç¯å¢ƒå®‰é™ï¼Œé¿å…æ‚éŸ³</li>
                <li>å¦‚æœæ— æ³•å½•éŸ³ï¼Œè¯·å°è¯•é‡å¯Safari</li>
            </ol>
        </div>

        <div id="tips">
            <h3>ğŸ’¡ å®ç”¨è‹±æ–‡è¡¨è¾¾æŠ€å·§</h3>
            <p><strong>ä¸‡èƒ½å¥å¼ (é€‚ç”¨äºæ‰€æœ‰è¯é¢˜):</strong></p>
            <ul>
                <li><strong>å¼€å¤´è¡¨è¾¾:</strong> "Well, I think that..." / "In my opinion..."</li>
                <li><strong>è¿‡æ¸¡è¿æ¥:</strong> "On the one hand... on the other hand..."</li>
                <li><strong>ä¸¾ä¾‹è¯´æ˜:</strong> "For example..." / "A good example is..."</li>
                <li><strong>è¡¨è¾¾ä¸ç¡®å®š:</strong> "I'm not sure but..."</li>
                <li><strong>æ€»ç»“é™ˆè¿°:</strong> "In conclusion..."</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–æ‰€æœ‰DOMå…ƒç´ 
            const generateBtn = document.getElementById('generateBtn');
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            const evaluateBtn = document.getElementById('evaluateBtn');
            const difficultySelect = document.getElementById('difficulty');
            const topicDisplay = document.getElementById('topic');
            const outputDisplay = document.getElementById('output');
            const scoreDisplay = document.getElementById('score');
            const feedbackDisplay = document.getElementById('feedback');
            const errorDisplay = document.getElementById('error');
            
            // ç³»ç»Ÿå˜é‡
            let recognition;
            let isRecording = false;
            let userResponse = "";
            let currentTopic = "";
            let currentDifficulty = "";
            
            // ä¸»é¢˜æ•°æ®åº“
            const topics = {
                easy: [
                    "è‡ªæˆ‘ä»‹ç» (Introduce yourself)",
                    "ä½ çš„å…´è¶£çˆ±å¥½ (Your hobbies)",
                    "æœ€å–œæ¬¢çš„é£Ÿç‰© (Favorite food)",
                    "æè¿°ä½ çš„å®¶äºº (Describe your family)",
                    "æ˜¨å¤©åšäº†ä»€ä¹ˆ (What you did yesterday)"
                ],
                medium: [
                    "ä¸€æ¬¡éš¾å¿˜çš„æ—…è¡Œ (A memorable trip)",
                    "å¦‚ä½•åº¦è¿‡å‘¨æœ« (How you spend weekends)",
                    "æœ€å–œæ¬¢çš„ç”µå½± (Favorite movie)",
                    "é‡è¦çš„å…¨çƒé—®é¢˜ (Important global issue)",
                    "ä½ çš„ç†æƒ³å·¥ä½œ (Your ideal job)"
                ],
                hard: [
                    "ç§‘æŠ€å¯¹ç”Ÿæ´»çš„å½±å“ (Technology's impact)",
                    "ç¯å¢ƒä¿æŠ¤çš„é‡è¦æ€§ (Environmental protection)",
                    "äººå·¥æ™ºèƒ½çš„å½±å“ (AI's impact on society)",
                    "å…¨çƒåŒ–å¯¹æ–‡åŒ–çš„å½±å“ (Globalization's effects)",
                    "æ•™è‚²ç³»ç»Ÿæ”¹é© (Education system reform)"
                ]
            };
            
            // CEFRè¯„ä¼°æ ‡å‡†
            const cefrCriteria = {
                A1: { min: 60, max: 70, desc: "èƒ½ä½¿ç”¨ç®€å•çš„çŸ­è¯­å’Œå¥å­æè¿°ç†Ÿæ‚‰çš„è¯é¢˜" },
                A2: { min: 71, max: 80, desc: "èƒ½å°±ç†Ÿæ‚‰è¯é¢˜è¿›è¡ŒåŸºæœ¬äº¤æµ" },
                B1: { min: 81, max: 87, desc: "èƒ½å°±ç†Ÿæ‚‰è¯é¢˜è¿›è¡Œè¿è´¯è¡¨è¾¾" },
                B2: { min: 88, max: 93, desc: "èƒ½å°±å¹¿æ³›è¯é¢˜è¿›è¡Œæ¸…æ™°è¯¦ç»†è¡¨è¾¾" },
                C1: { min: 94, max: 98, desc: "èƒ½æµåˆ©è‡ªç„¶åœ°è¡¨è¾¾å¤æ‚æ€æƒ³" },
                C2: { min: 99, max: 100, desc: "èƒ½ç²¾ç¡®åŒºåˆ†ç»†å¾®æ„ä¹‰å·®åˆ«" }
            };
            
            // æ£€æŸ¥è¯­éŸ³è¯†åˆ«æ”¯æŒ
            function checkCompatibility() {
                if (!('webkitSpeechRecognition' in window) {
                    showError("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆChromeæˆ–Safari");
                    disableAllButtons();
                    generateBtn.disabled = false;
                    return false;
                }
                return true;
            }
            
            if (!checkCompatibility()) return;
            
            // äº‹ä»¶ç›‘å¬å™¨
            generateBtn.addEventListener('click', generateTopic);
            recordBtn.addEventListener('click', startRecording);
            stopBtn.addEventListener('click', stopRecording);
            evaluateBtn.addEventListener('click', evaluateSpeech);
            
            // ç”Ÿæˆä¸»é¢˜å‡½æ•°
            function generateTopic() {
                currentDifficulty = difficultySelect.value;
                const topicList = topics[currentDifficulty];
                currentTopic = topicList[Math.floor(Math.random() * topicList.length)];
                topicDisplay.textContent = currentTopic;
                recordBtn.disabled = false;
                evaluateBtn.disabled = true;
                userResponse = "";
                outputDisplay.textContent = "ï¼ˆå½•éŸ³åä¼šæ˜¾ç¤ºæ‚¨çš„å›ç­”ï¼‰";
                scoreDisplay.textContent = "ï¼ˆç‚¹å‡»è¯„ä¼°åæŸ¥çœ‹åˆ†æ•°ï¼‰";
                feedbackDisplay.textContent = "";
                errorDisplay.textContent = "";
            }
            
            // å¼€å§‹å½•éŸ³å‡½æ•°
            async function startRecording() {
                if (!currentTopic) {
                    showError("è¯·å…ˆç”Ÿæˆä¸»é¢˜ï¼");
                    return;
                }
                
                try {
                    // é¦–å…ˆè·å–éº¦å…‹é£æƒé™
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    
                    outputDisplay.textContent = "è¯·å¼€å§‹è¯´è¯...";
                    errorDisplay.textContent = "";
                    
                    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    recognition.lang = "en-US";
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;
                    recognition.continuous = false;  // iOSå¿…é¡»è®¾ä¸ºfalse
                    
                    recognition.onstart = function() {
                        isRecording = true;
                        outputDisplay.textContent = "ğŸ™ï¸ æ­£åœ¨å½•éŸ³...è¯·è¯´è¯";
                        recordBtn.disabled = true;
                        stopBtn.disabled = false;
                        evaluateBtn.disabled = true;
                        recordBtn.classList.add("recording");
                    };
                    
                    recognition.onresult = function(event) {
                        const transcript = event.results[0][0].transcript;
                        userResponse = transcript;
                        outputDisplay.textContent = userResponse;
                        evaluateBtn.disabled = false;
                    };
                    
                    recognition.onerror = function(event) {
                        handleRecognitionError(event.error);
                    };
                    
                    recognition.onend = function() {
                        if (isRecording) {
                            stopRecording();
                            if (!userResponse) {
                                outputDisplay.textContent = "æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•";
                            }
                        }
                    };
                    
                    recognition.start();
                } catch (err) {
                    handleRecognitionError(err.name || err.message);
                }
            }
            
            // åœæ­¢å½•éŸ³å‡½æ•°
            function stopRecording() {
                if (isRecording && recognition) {
                    recognition.stop();
                }
                isRecording = false;
                recordBtn.disabled = false;
                stopBtn.disabled = true;
                recordBtn.classList.remove("recording");
            }
            
            // é”™è¯¯å¤„ç†
            function handleRecognitionError(error) {
                const errorMap = {
                    'not-allowed': 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·å‰å¾€è®¾ç½® > Safari > éº¦å…‹é£æƒé™ å¹¶å…è®¸è®¿é—®',
                    'no-speech': 'æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é è¿‘éº¦å…‹é£è¯´è¯',
                    'audio-capture': 'éº¦å…‹é£ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥è®¾å¤‡',
                    'network': 'ç½‘ç»œé—®é¢˜å¯¼è‡´è¯†åˆ«å¤±è´¥',
                    'service-not-allowed': 'è¯·ä½¿ç”¨Chromeæˆ–æ›´æ–°Safari',
                    'default': 'è¯†åˆ«é”™è¯¯: ' + error
                };
                
                const message = errorMap[error] || errorMap['default'];
                showError(message);
                stopRecording();
            }
            
            // è¯„ä¼°å‡½æ•°
            function evaluateSpeech() {
                if (!userResponse) {
                    showError("æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•");
                    return;
                }
                
                // åˆ†æç‰¹å¾
                const wordCount = userResponse.split(/\s+/).length;
                const uniqueWords = new Set(userResponse.toLowerCase().match(/\b[a-z]+\b/g) || []).size;
                const vocabRatio = uniqueWords / Math.max(1, wordCount);
                const connectors = (userResponse.match(/because|although|however|therefore|moreover/g) || []).length;
                
                // åˆ†æ•°è®¡ç®—
                let score = Math.min(100, 60 + 
                    Math.min(20, wordCount * 0.5) + 
                    (vocabRatio * 20) + 
                    (connectors * 3) +
                    (currentDifficulty === 'medium' ? 5 : 0) +
                    (currentDifficulty === 'hard' ? 10 : 0)
                );
                
                // ç¡®å®šCEFRçº§åˆ«
                const cefrLevel = Object.entries(cefrCriteria).find(
                    ([_, range]) => score >= range.min && score <= range.max
                )?.[0] || "A1";
                
                // æ˜¾ç¤ºç»“æœ
                scoreDisplay.innerHTML = `
                    <strong>CEFRç­‰çº§:</strong> ${cefrLevel}<br>
                    <strong>å¾—åˆ†:</strong> ${Math.round(score)}/100<br>
                    <em>${cefrCriteria[cefrLevel].desc}</em>
                `;
                
                // ç”Ÿæˆåé¦ˆ
                feedbackDisplay.innerHTML = `
                    <p><strong>åˆ†æç»“æœ:</strong></p>
                    <ul>
                        <li>å›ç­”é•¿åº¦: ${wordCount} è¯</li>
                        <li>è¯æ±‡å¤šæ ·æ€§: ${Math.round(vocabRatio*100)}%</li>
                        <li>è¿æ¥è¯ä½¿ç”¨: ${connectors} å¤„</li>
                    </ul>
                    <p><strong>å­¦ä¹ å»ºè®®:</strong></p>
                    <ul>
                        ${getLearningTips(cefrLevel)}
                    </ul>
                `;
            }
            
            function getLearningTips(level) {
                const tips = {
                    A1: "<li>æ¯å¤©ç»ƒä¹ 5ä¸ªåŸºç¡€å¥å­</li><li>ä½¿ç”¨'My name is...'ç­‰ç®€å•å¥å‹</li>",
                    A2: "<li>å­¦ä¹ å¸¸ç”¨åŠ¨è¯çŸ­è¯­</li><li>ç»ƒä¹ æè¿°æ—¥å¸¸æ´»åŠ¨</li>",
                    B1: "<li>é˜…è¯»çŸ­ç¯‡è‹±æ–‡æ–‡ç« </li><li>å­¦ä¹ è¿æ¥è¯ç”¨æ³•</li>",
                    B2: "<li>è§‚çœ‹è‹±æ–‡è§†é¢‘å¹¶è·Ÿè¯»</li><li>ç»ƒä¹ è¡¨è¾¾è§‚ç‚¹</li>",
                    C1: "<li>å­¦ä¹ å­¦æœ¯è¯æ±‡</li><li>ç»ƒä¹ è¾©è®ºæŠ€å·§</li>",
                    C2: "<li>ç²¾ä¿®å‘éŸ³è¯­è°ƒ</li><li>å­¦ä¹ ä¸“ä¸šé¢†åŸŸæœ¯è¯­</li>"
                };
                return tips[level] || tips.A1;
            }
            
            function showError(message) {
                errorDisplay.innerHTML = "âŒ " + message;
            }
            
            function disableAllButtons() {
                [recordBtn, stopBtn, evaluateBtn].forEach(btn => btn.disabled = true);
            }
            
            // åˆå§‹çŠ¶æ€
            recordBtn.disabled = true;
            stopBtn.disabled = true;
            evaluateBtn.disabled = true;
        });
    </script>
</body>
</html>